<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foodie - Chat Layout</title>
    <style>
      /* Global Styles */
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      /* Modal styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 8px;
        width: 300px;
        text-align: center;
      }

      /* File input and preview styles */
      .file-input-container {
        margin-bottom: 20px;
      }

      #image-input {
        display: none; /* Hide the default file input */
      }

      #image-preview {
        max-width: 100%;
        max-height: 150px;
        border-radius: 8px;
        margin-top: 10px;
      }

      /* Button styles */
      .button-container {
        display: flex;
        justify-content: space-between;
        gap: 10px;
      }

      .upload-button,
      .close-modal {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        flex: 1;
      }

      .upload-button {
        background-color: #007bff; /* Blue color */
        color: #fff;
      }

      .upload-button:hover {
        background-color: #0056b3; /* Darker blue on hover */
      }

      .close-modal {
        background-color: #6c757d; /* Gray color */
        color: #fff;
      }

      .close-modal:hover {
        background-color: #5a6268; /* Darker gray on hover */
      }

      /* Sidebar Styles */
      .sidebar {
        width: 250px;
        background-color: #000; /* Juodas fonas */
        color: #fff;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        align-items: center; /* Centruojame turinį horizontaliai */
      }

      .sidebar h1 {
        font-size: 2rem;
        margin-bottom: 20px;
        text-transform: uppercase; /* Pavadinimas didžiosiomis raidėmis */
        text-align: center; /* Centruojame tekstą */
        color: #fff; /* Baltas tekstas */
      }

      .sidebar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        width: 100%; /* Užima visą plotį */
      }

      .sidebar ul li {
        margin-bottom: 10px;
      }

      .sidebar ul li a {
        color: #fff;
        text-decoration: none;
        font-size: 1rem;
        display: block;
        padding: 10px;
        border-radius: 4px;
        transition: background-color 0.3s;
      }

      .sidebar ul li a:hover {
        background-color: #333; /* Tamsesnis atspalvis užvedus */
      }

      /* Main Content Styles */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        background-color: #f4f4f4;
        padding: 20px;
        overflow-y: auto;
      }

      .chat-area {
        flex: 1;
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow-y: auto;
      }

      .chat-area h2 {
        font-size: 1.2rem;
        margin-bottom: 20px;
      }

      .chat-messages {
        margin-bottom: 20px;
      }

      .chat-messages .message {
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
        background-color: #e9ecef;
        white-space: pre;
      }

      .chat-input-container {
        display: flex;
        gap: 10px;
        align-items: center;
        background-color: #fff;
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .chat-input-container textarea {
        flex: 1;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
        resize: none;
        font-size: 1rem;
      }

      .chat-input-container button {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background-color: #007bff;
        color: #fff;
        cursor: pointer;
        font-size: 1rem;
      }

      .chat-input-container button:hover {
        background-color: #0056b3;
      }

      .chat-input-container .photo-buttons {
        display: flex;
        gap: 10px;
      }

      .chat-input-container .photo-buttons button {
        background-color: #28a745;
      }

      .chat-input-container .photo-buttons button:hover {
        background-color: #218838;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .sidebar {
          width: 200px;
        }

        .sidebar h1 {
          font-size: 1.5rem;
        }

        .sidebar ul li a {
          font-size: 0.9rem;
        }

        .chat-area h2 {
          font-size: 1rem;
        }

        .chat-input-container textarea {
          font-size: 0.9rem;
        }

        .chat-input-container button {
          padding: 8px 16px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 480px) {
        .sidebar {
          width: 150px;
        }

        .sidebar h1 {
          font-size: 1.2rem;
        }

        .sidebar ul li a {
          font-size: 0.8rem;
        }

        .chat-area h2 {
          font-size: 0.9rem;
        }

        .chat-input-container textarea {
          font-size: 0.8rem;
        }

        .chat-input-container button {
          padding: 6px 12px;
          font-size: 0.8rem;
        }
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <div class="sidebar">
      <h1>FOODIE</h1>
      <!-- Pavadinimas didžiosiomis raidėmis -->
      <ul>
        <li><a href="#">Home</a></li>
        <li><a href="#">Recipes</a></li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <div class="chat-area">
        <h2>Chat</h2>
        <div id="chat-messages" class="chat-messages">
          <div class="message">Hello! How can I help you today?</div>
          <div class="message">I need help with my food order.</div>
        </div>
      </div>

      <!-- Chat Input and Buttons -->
      <div class="chat-input-container">
        <textarea id=prompt-area placeholder="Type your message..."></textarea>
        <div class="photo-buttons">
          <button id="add-photo-button">Add Photo</button>
          <button id="scan-camera-button">Scan Object with Camera</button>
        </div>
        <button id="send-button">Send</button>
      </div>
    </div>
    <!-- Modal Structure -->
    <div id="upload-modal" class="modal">
      <div class="modal-content">
        <h4>Upload Photo</h4>
        <form
          id="upload-form"
          action="{% url 'upload_image' %}"
          method="POST"
          enctype="multipart/form-data"
        >
          {% csrf_token %}
          <!-- File input and image preview -->
          <div class="file-input-container">
            <input
              type="file"
              id="image-input"
              name="image"
              accept="image/jpeg"
              required
            />
            <label for="image-input" class="upload-button">Choose Photo</label>
            <img
              id="image-preview"
              src="#"
              alt="Preview"
              style="display: none"
            />
          </div>
          <!-- Upload and close buttons -->
          <div class="button-container">
            <button type="submit" class="upload-button">Upload</button>
            <button type="button" class="close-modal">Close</button>
          </div>
        </form>
      </div>
    </div>
    <script type="module">
            import { GoogleGenerativeAI } from "https://cdn.skypack.dev/@google/generative-ai";
            console.log("GoogleGenerativeAI loaded:", GoogleGenerativeAI);
      // JavaScript for handling button clicks
      document
        .getElementById("add-photo-button")
        .addEventListener("click", function () {
          document.getElementById("upload-modal").style.display = "flex"; // Open the modal
        });

      document
        .querySelector(".close-modal")
        .addEventListener("click", closeModal);

      document
        .getElementById("scan-camera-button")
        .addEventListener("click", function () {
          alert("Scan Object with Camera button clicked!");
          // Add logic to open the camera
        });

      document
        .getElementById("send-button")
        .addEventListener("click", sendUserPrompt);
      document
        .getElementById("upload-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          let formData = new FormData(this);

          fetch("{% url 'upload_image' %}", {
            method: "POST",
            body: formData,
            headers: {
              "X-CSRFToken": document.querySelector(
                "[name=csrfmiddlewaretoken]"
              ).value,
            },
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.message) {
                alert(data.message); // Success message
                document.getElementById("upload-modal").style.display = "none"; // Close the modal

                // Clear the file input
                closeModal();
              } else if (data.error) {
                alert(data.error); // Error message
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("Something went wrong!");
            });
        });
      document
        .getElementById("image-input")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          const preview = document.getElementById("image-preview");

          if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();

            reader.onload = function (e) {
              preview.src = e.target.result;
              preview.style.display = "block";
            };

            reader.readAsDataURL(file);
          } else {
            preview.style.display = "none";
          }
        });
      function closeModal() {
        const modal = document.getElementById("upload-modal");
        const fileInput = document.getElementById("image-input");
        const imagePreview = document.getElementById("image-preview");

        // Reset the file input and clear the preview
        fileInput.value = ""; // Clear the file input
        imagePreview.src = "#"; // Clear the image preview
        imagePreview.style.display = "none"; // Hide the preview

        // Hide the modal
        modal.style.display = "none";
      }

      async function sendPrompt(userPrompt){
        const genAI = new GoogleGenerativeAI(atob("QUl6YVN5RGYzNWd2SWVzT01XTFJJeHB3blFuOUc1MEpJOVpsTkNz"));
        const model = genAI.getGenerativeModel({ model: "gemini-2.0-flash" });
        const prompt = userPrompt;
        
        const result = await model.generateContent(prompt);
        console.log(result.response.text());
        return result;
      }

      async function addMessage(text){
        var message = document.createElement('div');
        message.classList.add("message")
        message.textContent = text;
        document.getElementById("chat-messages").appendChild(message);  
      }

      async function sendUserPrompt() {
        addMessage("You entered: " + document.getElementById("prompt-area").value)
        var templatePrompt1 = "Generate 3 recipes using these ingredients: ";
        var templatePrompt2 = ". One of these recipes must made with only the mentioned ingredients and nothing more. Your recipes must include the name of the dish, cooking time, ingredients and instructions. Your reply text should only consist of the recipes and nothing more.";
        var result = await sendPrompt(templatePrompt1 + document.getElementById("prompt-area").value + templatePrompt2);
        addMessage(result.response.text())
      }
    </script>
  </body>
</html>
