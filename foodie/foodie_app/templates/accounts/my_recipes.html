{% load static %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foodie - Chat Layout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>    </script>
        <link rel="stylesheet" href ="{% static 'styles1.css' %}" />

</head>
<body>
<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>FOODIE</h1>
        </div>

        <nav class="sidebar-nav">
            <a href="{% url 'home' %}"
               class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
                Home
            </a>

            <a href="{% url 'my_recipes' %}"
               class="nav-link {% if request.resolver_match.url_name == 'my_recipes' %}active{% endif %}">
                History
            </a>

            <a href="{% url 'top_recipes' %}"
               class="nav-link {% if request.resolver_match.url_name == 'top_recipes' %}active{% endif %}">
                Top Recipes
            </a>

            <a href="{% url 'logout' %}" class="nav-link">Logout</a>
            <a href="{% url 'delete_account' %}" class="nav-link danger">Delete Account</a>
        </nav>
    </aside>

    <!-- Main Content -->
<div class="main-content">
    <div class="history-wrapper">
        <div class="history-header">
            <h2>Recipe History</h2>
            <div class="history-filters">
                <input type="date" class="date-input" />
            </div>
        </div>

        <!-- Galima vƒóliau daryti Today / Yesterday grupes, kol kas paliekam vienƒÖ sekcijƒÖ -->
        <section class="history-section">
            <h3 class="section-title">All recipes</h3>
            <div class="recipes-grid" id="chat-messages"></div>
        </section>
    </div>
</div>

</div>

<div id="tag-add-modal" class="tag-modal">
        <div class="tag-modal-content">
            <h4 id="tag-add-modal-header">Add tag</h4>
            <form id="tag-add-form" action="{% url 'upload_image' %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <!-- File input and image preview -->
                <div class="card-actions">
                    <label for="tagInput">Tag</label>
                    <input type="text" id="tagInput" name="tagInput"/>
                </div>
                <!-- Upload and close buttons -->
                <div class="button-container">
                    <button type="button" class="add-tag">Add tag</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>


<script id="recipes-data" type="application/json">
    {{ recipes_json|safe }}
</script>


<script>
  // Receptai i≈° Django
  const recipes = JSON.parse(
    document.getElementById("recipes-data").textContent
  );

  const grid = document.getElementById("chat-messages");
  const dateInput = document.querySelector(".date-input");

  // I≈°traukiam datƒÖ YYYY-MM-DD i≈° created_at
  function getRecipeDate(recipe) {
    if (recipe.created_at) {
      return recipe.created_at.toString().slice(0, 10);
    }
    return "";
  }

  // Universalus helperis: i≈° "['A', 'B']" -> ['A','B']
  function parseList(field) {
    if (!field) return [];
    if (Array.isArray(field)) return field;

    try {
      // pakeiƒçiam viengubas kabutes ƒØ dvigubas ir parse'inam kaip JSON
      const jsonText = field.toString().replace(/'/g, '"');
      const parsed = JSON.parse(jsonText);
      if (Array.isArray(parsed)) return parsed;
    } catch (e) {
      // fallback ‚Äì skaidom per kablelius
      return field
        .toString()
        .replace(/^\[/, "")
        .replace(/\]$/, "")
        .replace(/'/g, "")
        .split(",")
        .map((s) => s.trim())
        .filter(Boolean);
    }
    return [];
  }

  // Formatuojam ingredient≈≥ tekstƒÖ kortelei
  function formatIngredients(field) {
    return parseList(field).join(", ");
  }

  // ===== PDF generavimas tik su reikalingais laukais =====
  function SaveRecipeAsPDF(recipe) {
    const doc = new jsPDF();

    const title = recipe.name || "Recipe";
    const ingredients = parseList(recipe.ingredients);
    const instructions = parseList(recipe.instructions);

    let lines = [];

    lines.push(title);
    lines.push(""); // tu≈°ƒçia eilutƒó

    lines.push("Ingredients:");
    ingredients.forEach((ing) => {
      lines.push("- " + ing);
    });

    lines.push(""); // tarpas
    lines.push("Instructions:");
    instructions.forEach((step, i) => {
      lines.push(`${i + 1}. ${step}`);
    });

    const text = lines.join("\n");

    doc.setFontSize(10);
    const split = doc.splitTextToSize(text, 180); // kad nelipt≈≥ u≈æ kra≈°t≈≥
    doc.text(split, 10, 10);
    doc.save(`${title}.pdf`);
  }

  function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

  // Pagrindinƒó funkcija ‚Äì perpie≈°ti korteles su (ar be) datos filtro
  function renderRecipes(filterDate = null) {
    grid.innerHTML = "";

    

    const csrftoken = getCookie('csrftoken');

    recipes.forEach((recipe) => {
      const recipeDate = getRecipeDate(recipe);

      if (filterDate && recipeDate !== filterDate) {
        return;
      }

      const card = document.createElement("article");
      card.className = "recipe-card";

      const title = recipe.name || "Untitled recipe";
      const cookingTime = recipe.cookingTime || "N/A";
      const ingredientsText = formatIngredients(recipe.ingredients);
      const difficulty = recipe.difficulty || "Medium";

      card.innerHTML = `
        <div class="recipe-card-header">
          <div>
            <h4 class="recipe-title">${title}</h4>
            <p class="recipe-subtitle">
              ${recipeDate || ""} ${recipe.tag == '' ? '' : 'Tag: ' + recipe.tag}
            </p>
          </div>
          <button class="icon-button" type="button">üçΩ</button>
        </div>

        <div class="recipe-meta">
          <span class="badge badge-medium">${difficulty}</span>
          <span class="meta-time">‚è± ${cookingTime}</span>
        </div>

        <div class="recipe-body">
          <p class="label">Ingredients:</p>
          <p class="ingredients">${ingredientsText}</p>
        </div>

        <div class="card-actions">
            ${
            recipe.tag == ""
              ? `<button class="tag-add-btn" type="button">Add Tag</button>`
              : `<button class="tag-del-btn" type="button">Remove Tag</button>
              <button class="tag-add-btn" type="button">Change Tag</button>
              `
          }
          <button class="save-btn" type="button">Save as PDF</button>
        </div>
      `;

      const saveBtn = card.querySelector(".save-btn");
      // ƒçia perduodam ne kortelƒô, o RECEPTƒÑ
      saveBtn.addEventListener("click", () => SaveRecipeAsPDF(recipe));
      
      setupModal(card, recipe);

      grid.appendChild(card);
    });
  } 

     function setupModal(card, recipe){
        if(recipe.tag == ""){
            const tagAddBtn = card.querySelector(".tag-add-btn");
            tagAddBtn.addEventListener("click", () => {
                document.getElementById("tag-add-modal").style.display = "flex";
            });
        } else {
            const tagAddBtn = card.querySelector(".tag-add-btn");
            tagAddBtn.addEventListener("click", () => {
                document.getElementById("tag-add-modal").style.display = "flex";
                document.getElementById("tag-add-modal-header").innerText = "Edit tag";
                document.querySelector(".add-tag").innerText = "Save changes";
            });
            const tagDelBtn = card.querySelector(".tag-del-btn");
            tagDelBtn.addEventListener("click", () => {
                sendTag('', recipe.id);
                card.querySelector(".card-actions").innerHTML = `
                <button class="tag-add-btn" type="button">Add Tag</button>
                <button class="save-btn" type="button">Save as PDF</button>
                `;
            });
            
        }
        document.querySelector(".cancel-btn").addEventListener("click", () => {
            document.getElementById("tag-add-modal").style.display = "none";
        });
    }

  // Inicinis atvaizdavimas ‚Äì visi receptai
  renderRecipes();

  // Filtravimas pagal datƒÖ
  if (dateInput) {
    dateInput.addEventListener("change", () => {
      const selected = dateInput.value || null;
      renderRecipes(selected);
    });
  }
        
    function openTagEdit(tag, buttonElement, recipeId) {
        const messageText = tag;
        const container = document.createElement('div');

        const editInput = document.createElement('textarea');
        editInput.value = messageText;
        editInput.style.width = '100%';
        editInput.style.height = '60px';
        editInput.maxLength = 300; // Set max length for the textarea

        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save';
        saveButton.style.backgroundColor = '#28a745';
        saveButton.style.color = '#fff';
        saveButton.style.border = 'none';
        saveButton.style.padding = '5px 10px';
        saveButton.style.borderRadius = '4px';
        saveButton.style.cursor = 'pointer';
        
        const removeButton = document.createElement('button');
        removeButton.textContent = 'Remove Tag';
        removeButton.style.backgroundColor = '#ff0000';
        removeButton.style.color = '#fff';
        removeButton.style.border = 'none';
        removeButton.style.padding = '5px 10px';
        removeButton.style.borderRadius = '4px';
        removeButton.style.cursor = 'pointer';
        removeButton.style.marginLeft = '10px';

        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.style.backgroundColor = '#ff0000';
        cancelButton.style.color = '#fff';
        cancelButton.style.border = 'none';
        cancelButton.style.padding = '5px 10px';
        cancelButton.style.borderRadius = '4px';
        cancelButton.style.cursor = 'pointer';
        cancelButton.style.marginLeft = '10px';

        const editCharCounter = document.createElement('div');
        editCharCounter.className = 'char-counter-small';
        editCharCounter.style.color = '#000';
        editCharCounter.innerHTML = `<span id="edit-char-count">${messageText.length}</span>/300`;

        // Replace message content with input, counter, and save button
        const originalButton = buttonElement;

        container.appendChild(editInput);
        container.appendChild(editCharCounter);
        container.appendChild(saveButton);
        container.appendChild(removeButton);
        container.appendChild(cancelButton);

        const parent = originalButton.parentNode;
        parent.replaceChild(container, originalButton);

        // Update character counter while editing
        editInput.addEventListener('input', function() {
            const currentLength = editInput.value.length;
            document.getElementById('edit-char-count').textContent = currentLength;

            // Optional: Change color if approaching the limit
            if (currentLength >= 280) {
                editCharCounter.style.color = 'red';
            } else {
                editCharCounter.style.color = '#000';
            }
        });

        // Save the edited message
        saveButton.addEventListener('click', async function() {
            parent.replaceChild(originalButton, container);
            await sendTag(editInput.value, recipeId); // Replace 1 with actual recipe ID
            
            let tagField = document.getElementById(`recipe${recipeId}`)
            tagField.innerText = `Tag: ${editInput.value}\n`;
        });

        removeButton.addEventListener('click', async function() {
            parent.replaceChild(originalButton, container);
            await sendTag('', recipeId); // Replace 1 with actual recipe ID
            
            let tagField = document.getElementById(`recipe${recipeId}`)
            tagField.innerText = '';
        });

        cancelButton.addEventListener('click', function() {
            parent.replaceChild(originalButton, container);
        });
    }

    async function sendTag(newTag, recipeId){
        const csrftoken = getCookie('csrftoken');
        let data = { 
            "tag": newTag,
        };
        let response = await fetch(`/edit-recipe/${recipeId}/`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
    }
</script>




</html>