{% load static %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foodie - Chat Layout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>    </script>
        <link rel="stylesheet" href ="{% static 'styles.css' %}" />

</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <h1>FOODIE</h1>
        <ul>
            <li><a href="{% url 'home' %}">Home</a></li>
            <li><a href="{% url 'my_recipes' %}">Recipes</a></li>
            <li><a href="{% url 'top_recipes' %}">TOP Recipes</a></li>
            <li><a href="{% url 'logout' %}">Logout</a></li>
            <li><a href="{% url 'delete_account' %}" >Delete Account</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="chat-area">
            <h2>Chat with Foodie</h2> <!-- Pakeistas tekstas ir stilius -->
            <div class="chat-messages" id="chat-messages">
            </div>
        </div>
    </div>

</body>

<script id="recipes-data" type="application/json">
    {{ recipes_json|safe }}
</script>


<script>
    const recipes = JSON.parse(
        document.getElementById('recipes-data').textContent
    );
    const chatMessages = document.getElementById('chat-messages');

    const container = document.getElementById('recipes-container');

    function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

        const csrftoken = getCookie('csrftoken');

    recipes.forEach((recipe) => {
        const botMessage = document.createElement('div');
            botMessage.className = 'message bot';
            botMessage.innerHTML = `<strong>${recipe.name}</strong><br/>` +
                                (recipe.tag != '' ? `<em id="recipe${recipe.id}">Tag: ${recipe.tag}</em><br/>` : `<em id="recipe${recipe.id}"></em>`) +
                                `Cooking Time: ${recipe.cookingTime}<br/>` +
                                `<strong>Ingredients:</strong><br/>${recipe.ingredients.map(ing => `- ${ing}`).join('<br/>')}<br/>` +
                                `<strong>Instructions:</strong><br/>${recipe.instructions.map((inst, index) => `${index + 1}. ${inst}`).join('<br/>')}`;
                    
            const saveBtn = document.createElement('button');
            saveBtn.className = 'edit-button';
            saveBtn.textContent = 'Save as PDF';
            saveBtn.addEventListener('click', () => SaveRecipeAsPDF(botMessage));
            botMessage.appendChild(saveBtn);

            const tagBtn = document.createElement('button');
            tagBtn.className = 'edit-button';
            tagBtn.style.top = '20px';
            tagBtn.textContent = 'Tag';
            tagBtn.addEventListener('click', () => openTagEdit(recipe.tag, tagBtn, recipe.id));
            botMessage.appendChild(tagBtn);
            
            chatMessages.appendChild(botMessage);
    });

    function SaveRecipeAsPDF(messageElement) {
          const doc = new jsPDF();
          const text = messageElement.textContent;
  
          doc.setFontSize(8);
          doc.text(text, 10, 10);
          // force download
          doc.save('Recipe.pdf');
        }

    function openTagEdit(tag, buttonElement, recipeId) {
        const messageText = tag;
        const container = document.createElement('div');

        const editInput = document.createElement('textarea');
        editInput.value = messageText;
        editInput.style.width = '100%';
        editInput.style.height = '60px';
        editInput.maxLength = 300; // Set max length for the textarea

        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save';
        saveButton.style.backgroundColor = '#28a745';
        saveButton.style.color = '#fff';
        saveButton.style.border = 'none';
        saveButton.style.padding = '5px 10px';
        saveButton.style.borderRadius = '4px';
        saveButton.style.cursor = 'pointer';
        
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.style.backgroundColor = '#ff0000';
        cancelButton.style.color = '#fff';
        cancelButton.style.border = 'none';
        cancelButton.style.padding = '5px 10px';
        cancelButton.style.borderRadius = '4px';
        cancelButton.style.cursor = 'pointer';
        cancelButton.style.marginLeft = '10px';

        const editCharCounter = document.createElement('div');
        editCharCounter.className = 'char-counter-small';
        editCharCounter.style.color = '#000';
        editCharCounter.innerHTML = `<span id="edit-char-count">${messageText.length}</span>/300`;

        // Replace message content with input, counter, and save button
        const originalButton = buttonElement;

        container.appendChild(editInput);
        container.appendChild(editCharCounter);
        container.appendChild(saveButton);
        container.appendChild(cancelButton);

        const parent = originalButton.parentNode;
        parent.replaceChild(container, originalButton);

        // Update character counter while editing
        editInput.addEventListener('input', function() {
            const currentLength = editInput.value.length;
            document.getElementById('edit-char-count').textContent = currentLength;

            // Optional: Change color if approaching the limit
            if (currentLength >= 280) {
                editCharCounter.style.color = 'red';
            } else {
                editCharCounter.style.color = '#000';
            }
        });

        // Save the edited message
        saveButton.addEventListener('click', async function() {
            parent.replaceChild(originalButton, container);
            await sendTag(editInput.value, recipeId); // Replace 1 with actual recipe ID
            
            let tagField = document.getElementById(`recipe${recipeId}`)
            tagField.innerText = `Tag: ${editInput.value}\n`;
        });

        cancelButton.addEventListener('click', function() {
            parent.replaceChild(originalButton, container);
        });
    }

    async function sendTag(newTag, recipeId){
        let data = { 
            "tag": newTag,
        };
        let response = await fetch(`/edit-recipe/${recipeId}/`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(data)
        });
    }
</script>
</html>