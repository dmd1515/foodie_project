{% load static %}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Foodie - Chat Layout</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js">
    </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js" integrity="sha384-NaWTHo/8YCBYJ59830LTz/P4aQZK1sS0SneOgAvhsIl3zBu8r9RevNg5lHCHAuQ/" crossorigin="anonymous"></script>    </script>
        <link rel="stylesheet" href ="{% static 'styles1.css' %}" />

</head>
<body>
<div class="layout">
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h1>FOODIE</h1>
        </div>

        <nav class="sidebar-nav">
            <a href="{% url 'home' %}"
               class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}">
                Home
            </a>

            <a href="{% url 'my_recipes' %}"
               class="nav-link {% if request.resolver_match.url_name == 'my_recipes' %}active{% endif %}">
                History
            </a>

            <a href="{% url 'top_recipes' %}"
               class="nav-link {% if request.resolver_match.url_name == 'top_recipes' %}active{% endif %}">
                Top Recipes
            </a>

            <a href="{% url 'logout' %}" class="nav-link">Logout</a>
            <a href="{% url 'delete_account' %}" class="nav-link danger">Delete Account</a>
        </nav>
    </aside>

    <!-- Main Content -->
<div class="main-content">
    <div class="history-wrapper">
        <div class="history-header">
            <h2>Recipe History</h2>
            <div class="history-filters">
                <input type="date" class="date-input" />
                <select class="tag-filter"></select>
            </div>
        </div>

        <!-- Galima vƒóliau daryti Today / Yesterday grupes, kol kas paliekam vienƒÖ sekcijƒÖ -->
        <section class="history-section">
            <h3 class="section-title">All recipes</h3>
            <div class="recipes-grid" id="chat-messages"></div>
        </section>
    </div>
</div>

</div>

<div id="tag-add-modal" class="tag-modal">
        <div class="tag-modal-content">
            <h4 id="tag-add-modal-header">Add tag</h4>
            <form id="tag-add-form" method="POST" >
                {% csrf_token %}
                <!-- File input and image preview -->
                <div class="card-actions">
                    <input type="text" id="tagInput" name="tagInput" placeholder="Enter tag..."/>
                </div>
                <!-- Upload and close buttons -->
                <div class="button-container">
                    <button type="button" class="add-tag">Add tag</button>
                    <button type="button" class="cancel-btn">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</body>


<script id="recipes-data" type="application/json">
    {{ recipes_json|safe }}
</script>


<script>
  // Receptai i≈° Django
    const recipes = JSON.parse(
        document.getElementById("recipes-data").textContent
    );

    const grid = document.getElementById("chat-messages");
    const dateInput = document.querySelector(".date-input");
    const tagSelect = document.querySelector(".tag-filter");
    let currentDateFilter = null;
    let currentTagFilter = "";
    let recipeId = 0;

    // I≈°traukiam datƒÖ YYYY-MM-DD i≈° created_at
    function getRecipeDate(recipe) {
        if (recipe.created_at) {
        return recipe.created_at.toString().slice(0, 10);
        }
        return "";
    }

  // Universalus helperis: i≈° "['A', 'B']" -> ['A','B']
    function parseList(field) {
        if (!field) return [];
        if (Array.isArray(field)) return field;

        try {
        // pakeiƒçiam viengubas kabutes ƒØ dvigubas ir parse'inam kaip JSON
        const jsonText = field.toString().replace(/'/g, '"');
        const parsed = JSON.parse(jsonText);
        if (Array.isArray(parsed)) return parsed;
        } catch (e) {
        // fallback ‚Äì skaidom per kablelius
        return field
            .toString()
            .replace(/^\[/, "")
            .replace(/\]$/, "")
            .replace(/'/g, "")
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
        }
        return [];
    }

  // Formatuojam ingredient≈≥ tekstƒÖ kortelei
    function formatIngredients(field) {
        return parseList(field).join(", ");
    }

    // ===== PDF generavimas tik su reikalingais laukais =====
    function SaveRecipeAsPDF(recipe) {
        const doc = new jsPDF();

        const title = recipe.name || "Recipe";
        const ingredients = parseList(recipe.ingredients);
        const instructions = parseList(recipe.instructions);

        let lines = [];

        lines.push(title);
        lines.push(""); // tu≈°ƒçia eilutƒó

        lines.push("Ingredients:");
        ingredients.forEach((ing) => {
        lines.push("- " + ing);
        });

        lines.push(""); // tarpas
        lines.push("Instructions:");
        instructions.forEach((step, i) => {
        lines.push(`${i + 1}. ${step}`);
        });

        const text = lines.join("\n");

        doc.setFontSize(10);
        const split = doc.splitTextToSize(text, 180); // kad nelipt≈≥ u≈æ kra≈°t≈≥
        doc.text(split, 10, 10);
        doc.save(`${title}.pdf`);
    } 

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function getUniqueTags(recipes) {
        const set = new Set();
        recipes.forEach(r => {
            if (r.tag && r.tag.trim() !== "") {
                set.add(r.tag.trim());
            }
        });
        return Array.from(set).sort();
    }

    function populateTagDropdown() {
        if (!tagSelect) return;

        // Clear existing options
        tagSelect.innerHTML = "";

        // "-" option for all recipes
        const allOption = document.createElement("option");
        allOption.value = "";
        allOption.textContent = "All tags";
        tagSelect.appendChild(allOption);

        // Add one option per unique tag
        const tags = getUniqueTags(recipes);
        tags.forEach(tag => {
            const opt = document.createElement("option");
            opt.value = tag;
            opt.textContent = tag;
            tagSelect.appendChild(opt);
        });
    }   

  // Pagrindinƒó funkcija ‚Äì perpie≈°ti korteles su (ar be) datos filtro
    function renderRecipes(filterDate = null, filterTag = null) {
        grid.innerHTML = "";
        const csrftoken = getCookie('csrftoken');

        recipes.forEach((recipe) => {
        const recipeDate = getRecipeDate(recipe);

        if (filterDate && recipeDate !== filterDate) {
            return;
        }

        if (filterTag && recipe.tag !== filterTag) {
            return;
        }

        const card = document.createElement("article");
        card.className = "recipe-card";

        const title = recipe.name || "Untitled recipe";
        const cookingTime = recipe.cookingTime || "N/A";
        const ingredientsText = formatIngredients(recipe.ingredients);
        const difficulty = recipe.difficulty || "Medium";

        card.innerHTML = `
            <div class="recipe-card-header">
            <div>
                <h4 class="recipe-title">${title}</h4>
                <p class="recipe-subtitle">
                ${recipeDate || ""} ${recipe.tag == '' ? '' : 'Tag: ' + recipe.tag}
                </p>
            </div>
            <button class="icon-button" type="button">üçΩ</button>
            </div>

            <div class="recipe-meta">
            <span class="badge badge-medium">${difficulty}</span>
            <span class="meta-time">‚è± ${cookingTime}</span>
            </div>

            <div class="recipe-body">
            <p class="label">Ingredients:</p>
            <p class="ingredients">${ingredientsText}</p>
            </div>

            <div class="card-actions">
                ${
                recipe.tag == ""
                ? `<button class="tag-add-btn" type="button">Add Tag</button>`
                : `<button class="tag-del-btn" type="button">Remove Tag</button>
                <button class="tag-add-btn" type="button">Change Tag</button>
                `
            }
            <button class="save-btn" type="button">Save as PDF</button>
            </div>
        `;

        const saveBtn = card.querySelector(".save-btn");
        // ƒçia perduodam ne kortelƒô, o RECEPTƒÑ
        saveBtn.addEventListener("click", () => SaveRecipeAsPDF(recipe));
        
        setupActionsModal(card, recipe);

        grid.appendChild(card);
        });

        document.querySelector(".add-tag").addEventListener("click", async () => {
            const newTag = document.getElementById("tagInput").value;
            await sendTag(newTag, recipeId);
            location.reload();
            document.getElementById("tag-add-modal").style.display = "none";
        });

        document.querySelector(".cancel-btn").addEventListener("click", () => {
            document.getElementById("tag-add-modal").style.display = "none";
        });
    }     

     function setupActionsModal(card, recipe){
        if(recipe.tag == ""){
            const tagAddBtn = card.querySelector(".tag-add-btn");
            tagAddBtn.addEventListener("click", () => {
                document.getElementById("tag-add-modal").style.display = "flex";
                recipeId = recipe.id;
            });
        } else {
            const tagAddBtn = card.querySelector(".tag-add-btn");
            tagAddBtn.addEventListener("click", () => {
                document.getElementById("tag-add-modal").style.display = "flex";
                document.getElementById("tag-add-modal-header").innerText = "Edit tag";
                document.querySelector(".add-tag").innerText = "Save changes";
                recipeId = recipe.id;
            });

            const tagDelBtn = card.querySelector(".tag-del-btn");
            tagDelBtn.addEventListener("click", async () => {
                await sendTag('', recipe.id);
                location.reload();
            });
        }
    }

    populateTagDropdown();
  // Inicinis atvaizdavimas ‚Äì visi receptai
    renderRecipes();

    // Filtravimas pagal datƒÖ
    if (dateInput) {
        dateInput.addEventListener("change", () => {
        currentDateFilter = dateInput.value || null;

        renderRecipes(filterDate = currentDateFilter, filterTag = currentTagFilter);
        });
    }

    if (tagSelect) {
    tagSelect.addEventListener("change", () => {
        currentTagFilter = tagSelect.value || ""; // "" means "all tags"
        renderRecipes(filterDate = currentDateFilter, filterTag = currentTagFilter);
    });
}

    async function sendTag(newTag, recipeId){
        const csrftoken = getCookie('csrftoken');
            const url = `/edit-recipe/${recipeId}/`;
                console.log('Sending tag to:', url, 'tag:', newTag);
        let data = { 
            "tag": newTag,
        };
        try {
            let response = await fetch(`/edit-recipe/${recipeId}/`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify(data)
            });
        } catch (err) {
            console.error('Fetch failed:', err);
        }
    }
</script>




</html>